<?xml version="1.0" encoding="UTF-8"?>
<!-- Copyright (c) 2003-2018 Broad Institute, Inc., Massachusetts Institute of Technology, and Regents 
    of the University of California. All rights reserved. -->
<project name="GSEA" default="create-jar" basedir=".">
    <!-- GLOBAL VARS -->
    <property name="dist.dir" value="${basedir}/dist_java9" />

    <target name="-init">
        <!-- Create the time stamp -->
        <tstamp>
            <format property="TODAY" pattern="MMMdd_yyyy_HHmmss" />
            <format property="time.stamp" pattern="yyyy-MM-dd_HHmmss" />
        </tstamp>
    </target>

    <target name="clean">
        <delete dir="${dist.dir}" failonerror="false" />
    </target>

    <target name="update-build-props" depends="-init">
        <!-- Increment the build properties. The application reads these from build.properties for display 
            in Help->About -->
        <propertyfile file="src/main/java/edu/mit/broad/genome/resources/build.properties">
            <entry key="build.number" type="int" operation="+" pattern="0000" default="0001" />
            <entry key="build.timestamp" type="date" operation="=" value="${time.stamp}"
                pattern="EEE, d MMM yyyy HH:mm:ss Z" />
        </propertyfile>
        <property file="src/main/java/edu/mit/broad/genome/resources/build.properties" />
        <property name="MINIMAL_JAR" value="gsea-minimal-${build.version}_java9.jar" />
    </target>

    <target name="compile" depends="-init"> <!-- temporarily skipping 'update-build-props' to avoid build # updates -->
        <property name="MINIMAL_JAR" value="gsea-minimal-DEV_java9.jar" />
        <mkdir dir="${dist.dir}/classes" />
        <javac target="1.9" source="1.9" debug="true" defaultexcludes="true" deprecation="false"
            destdir="${dist.dir}/classes" optimize="false" srcdir="src/main/java" memoryMaximumSize="1024M"
            fork="true" includes="**" failonerror="true" includeantruntime="false">
            <modulepath>
                <fileset dir="lib" includes="*.jar" />
                <fileset dir="lib_java9" includes="*.jar" />
            </modulepath>
        </javac>
    </target>

    <target name="copy-resources" depends="compile" description="Copies resources into build tree">
        <mkdir dir="${dist.dir}/classes/edu/mit/broad/geneome/resources" />
        <copy todir="${dist.dir}/classes/edu/mit/broad/genome/resources">
            <fileset dir="src/main/java/edu/mit/broad/genome/resources" />
        </copy>
    </target>

    <target name="create-jar" depends="-init, clean, compile, copy-resources"
        description="Builds minimal (GSEA-only) JAR">

        <jar basedir="${dist.dir}/classes" defaultexcludes="true" jarfile="${dist.dir}/${MINIMAL_JAR}">
            <fileset file="LICENSE.txt" />
            <fileset file="LICENSE-3RD-PARTY.txt" />
            <fileset file="README.md" />
            <manifest>
                <attribute name="Main-Class" value="xapps.gsea.GSEA" />
                <attribute name="Built-By" value="${user.name}" />
                <attribute name="GSEA-Build-Date" value="${TODAY}" />
                <attribute name="Permissions" value="all-permissions" />
                <attribute name="Application-Name" value="GSEA" />
                <attribute name="Codebase"
                    value="http://*.broadinstitute.org/gsea/software https://*.broadinstitute.org/gsea/software http://*.broadinstitute.org:8080/gsea/software https://*.broadinstitute.org:8080/gsea/software http://*.gsea-msigdb.org/gsea/software https://*.gsea-msigdb.org/gsea/software http://*.msigdb.org/gsea/software https://*.msigdb.org/gsea/software" />
            </manifest>
        </jar>
    </target>

    <target name="sign-jar" depends="create-jar" description="Sign the JAR">
        <!-- sign the jar. Note: (1) the current signing certificate expires in June, 2019 (2) the build must
            provide the keystore password as a Java command-line property, like "ant -Dstore-password=FOO..." 
            *NOTE*: this step may not be necessary for Java 9.    
        -->
        <signjar jar="${dist.dir}/${MINIMAL_JAR}" keystore="${keystore}" maxmemory="1024M"
            alias="codesign" tsaurl="http://timestamp.comodoca.com/rfc3161" storepass="${store-password}" />
    </target>

    <target name="build-release" depends="create-jar, sign-jar"
        description="Builds and signs the JAR with an updated build date and number" />

</project>
